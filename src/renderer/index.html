<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Brasser Tech</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div id="app" class="app">
    <!-- ========= SIDEBAR ========= -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="logo">BT</div>
        <div class="brand-name">Brasser Tech</div>

        <!-- Toggle “hambúrguer” (desktop: colapsa; mobile: overlay) -->
        <button id="sidebar-toggle" class="toggle-btn" title="Menu">
          <span class="icon">≡</span>
        </button>

        <!-- Botão X (somente overlay mobile) -->
        <button id="sidebar-close" class="mobile-close" aria-label="Fechar menu">×</button>
      </div>

      <nav class="nav">
        <div class="nav-top">
          <!-- Cadastrar -->
          <div class="nav-item" data-submenu="sub-cad">
            <span class="icon">＋</span>
            <span class="label">Cadastrar</span>
            <span class="caret">▾</span>
          </div>
          <div id="sub-cad" class="submenu">
            <a class="submenu-link" data-menu="cad:produtos" href="#/cadastro/produtos"><span class="icon">📦</span> Produtos</a>
            <a class="submenu-link" data-menu="cad:clientes" href="#/cadastro/clientes"><span class="icon">👤</span> Clientes</a>
            <a class="submenu-link" data-menu="cad:pedidos"  href="#/cadastro/pedidos"><span class="icon">🧾</span> Pedidos</a>
          </div>

          <!-- Consultar -->
          <div class="nav-item" data-submenu="sub-cons">
            <span class="icon">☎</span>
            <span class="label">Consultar</span>
            <span class="caret">▾</span>
          </div>
          <div id="sub-cons" class="submenu">
            <a class="submenu-link" data-menu="con:produtos" href="#/consulta/produtos"><span class="icon">📦</span> Produtos</a>
            <a class="submenu-link" data-menu="con:clientes" href="#/consulta/clientes"><span class="icon">👤</span> Clientes</a>
            <a class="submenu-link" data-menu="con:pedidos"  href="#/consulta/pedidos"><span class="icon">🧾</span> Pedidos</a>
          </div>

          <!-- Relatórios -->
          <div class="nav-item" data-submenu="sub-rep">
            <span class="icon">📊</span>
            <span class="label">Relatórios</span>
            <span class="caret">▾</span>
          </div>
          <div id="sub-rep" class="submenu">
            <a class="submenu-link" data-menu="rel:faturamento"     href="#/relatorios/faturamento"><span class="icon">💵</span> Faturamento</a>
            <a class="submenu-link" data-menu="rel:fat-por-cliente" href="#/relatorios/fat-por-cliente"><span class="icon">👥</span> Faturamento por Cliente</a>
          </div>

          <!-- Movimentação de pedidos -->
          <div>
            <a class="nav-item" data-menu="mon:pedidos" href="#/monitor-pedidos">
              <span class="icon">🖥️</span>
              <span class="label">Mov. Pedidos</span>
            </a>
          </div>

          <!-- Dashboard -->
          <a class="nav-item" data-menu="dash:home" href="#/">
            <span class="icon">🏠</span>
            <span class="label">Dashboard</span>
          </a>

          <!-- ====== Cardápio (NOVO) ====== -->
          <a class="nav-item" data-menu="cardapio" href="#/cardapio">
            <span class="icon">🍽️</span>
            <span class="label">Cardápio</span>
          </a>
        </div>

        <div class="nav-bottom">
          <a class="nav-item" data-menu="cfg" href="#/configuracoes">
            <span class="icon">⚙️</span>
            <span class="label">Configurações</span>
          </a>
          <a class="nav-item" data-menu="perfil" href="#/perfil">
            <span class="icon">👤</span>
            <span class="label">Perfil</span>
          </a>
        </div>
      </nav>
    </aside>

    <!-- ===== Painel lateral de submenus (desktop) ===== -->
    <aside class="subpanel" id="subpanel">
      <div class="subhead">
        <span id="subpanel-title">Menu</span>
        <button class="subclose" id="subpanel-close" title="Fechar">×</button>
      </div>
      <div class="slist" id="subpanel-body"></div>
    </aside>

    <!-- Backdrop (fecha overlay no mobile) -->
    <div id="sidebar-backdrop" class="backdrop" aria-hidden="true"></div>

    <!-- FAB (mobile) -->
    <button id="menu-fab" class="menu-fab" title="Abrir menu">☰</button>

    <!-- ========= CONTEÚDO ========= -->
    <main class="content">
      <header class="topbar">
        <h1 id="page-title">Dashboard</h1>
        <div class="userbar">
          <div class="avatar">O</div>
          <div class="name">Operador</div>
          <a href="#/perfil">Perfil</a>
        </div>
      </header>

      <section id="view-root" class="view-root"></section>

      <footer class="footerbar">
        <span id="footer-date"></span>
        <span>v1.0.0</span>
      </footer>
    </main>
  </div>

  <!-- Helpers mínimos -->
  <script>
    window.$viewRoot = () => document.getElementById('view-root');
    window.updatePageTitle = (t) => { const h = document.getElementById('page-title'); if (h) h.textContent = t; };
  </script>

  <!-- ===== Subpainel (desktop) ===== -->
  <script>
    const appEl      = document.getElementById('app');
    const subpanel   = document.getElementById('subpanel');
    const spTitle    = document.getElementById('subpanel-title');
    const spBody     = document.getElementById('subpanel-body');
    const spCloseBtn = document.getElementById('subpanel-close');
    const sidebarEl  = document.getElementById('sidebar');
    const viewRootEl = document.getElementById('view-root');
    const isMobile   = () => window.innerWidth <= 980;

    function closeSubpanel(){
      appEl.classList.remove('subopen');
      spBody.innerHTML = '';
      document.querySelectorAll('.nav-item.active').forEach(n => n.classList.remove('active'));
    }
    function openSubpanel(triggerEl, templateEl){
      if (!templateEl) return;
      const t = triggerEl.querySelector('.label')?.textContent?.trim() || 'Menu';
      spTitle.textContent = t;
      spBody.innerHTML = '';
      templateEl.querySelectorAll('a').forEach(a => {
        const clone = a.cloneNode(true);
        clone.addEventListener('click', () => closeSubpanel());
        spBody.appendChild(clone);
      });
      document.querySelectorAll('.nav-item.active').forEach(n => n.classList.remove('active'));
      triggerEl.classList.add('active');
      appEl.classList.add('subopen');
    }

    // Gatilho do painel (desktop) e inline (mobile)
    document.addEventListener('click', (ev) => {
      const trigger = ev.target.closest('.nav-item[data-submenu]');
      if (!trigger) return;
      const id = trigger.getAttribute('data-submenu');
      const tpl = document.getElementById(id);
      if (!tpl) return;

      if (isMobile()){
        tpl.classList.toggle('open');
        return;
      }
      const already = trigger.classList.contains('active') && appEl.classList.contains('subopen');
      if (already) { closeSubpanel(); return; }
      openSubpanel(trigger, tpl);
    });

    spCloseBtn?.addEventListener('click', closeSubpanel);
    document.addEventListener('keydown', (ev) => { if (ev.key === 'Escape') closeSubpanel(); });

    // Clicar fora fecha (mas não quando clicamos dentro do conteúdo)
    document.addEventListener('click', (ev) => {
      if (!appEl.classList.contains('subopen')) return;
      const insideSidebar = sidebarEl.contains(ev.target);
      const insidePanel   = subpanel.contains(ev.target);
      const insideView    = viewRootEl.contains(ev.target);
      if (!insideSidebar && !insidePanel && !insideView) closeSubpanel();
    });
  </script>

  <!-- ===== Overlay mobile / recolher ===== -->
  <script>
    (function () {
      const app       = document.querySelector('.app');
      const toggleBtn = document.getElementById('sidebar-toggle');
      const closeBtn  = document.getElementById('sidebar-close');
      const backdrop  = document.getElementById('sidebar-backdrop');
      const fab       = document.getElementById('menu-fab');
      const sidebar   = document.querySelector('.sidebar');
      const isMobile  = () => window.innerWidth <= 980;

      function openOverlay(){ app.classList.remove('subopen'); app.classList.add('mobile-open'); fab.classList.add('hide'); }
      function closeOverlay(){ app.classList.remove('mobile-open'); fab.classList.remove('hide'); }

      // Desktop: recolhe; Mobile: abre overlay
      toggleBtn?.addEventListener('click', (e) => {
        if (isMobile()) { e.preventDefault(); app.classList.contains('mobile-open') ? closeOverlay() : openOverlay(); }
        else { app.classList.toggle('collapsed'); }
      });

      closeBtn?.addEventListener('click', closeOverlay);
      backdrop?.addEventListener('click', closeOverlay);
      fab?.addEventListener('click', openOverlay);

      // Fechar overlay ao clicar em link/botão do menu (mobile)
      sidebar?.addEventListener('click', (ev) => {
        const hit = ev.target.closest('a,button');
        if (!hit) return;
        if (isMobile()) closeOverlay();
      });

      // Coerência ao redimensionar
      window.addEventListener('resize', () => {
        if (!isMobile()) { app.classList.remove('mobile-open'); fab?.classList.add('hide'); }
        else if (!app.classList.contains('mobile-open')) { fab?.classList.remove('hide'); }
      });

      // Estado inicial do FAB
      if (!isMobile()) fab?.classList.add('hide');

      // Data no rodapé
      (function () {
        const el = document.getElementById('footer-date');
        const d = new Date();
        const f = d.toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit', year:'numeric', weekday:'long' });
        if (el) el.textContent = f;
      })();
    })();
  </script>

  <script>
    (function(){
      try{
        const ipc = window.electron?.ipcRenderer || require('electron').ipcRenderer;
        ipc.on('auth:token', (data) => {
          try{
            if (data?.token) {
              localStorage.setItem('AUTH_TOKEN', data.token);
              window.__USER = data.user || null;
              if (!location.hash || location.hash === '#/login' || location.hash === '#/cadastro') {
                location.hash = '#/';
              }
            }
          }catch(e){ console.error('[auth-bridge] erro ao salvar token:', e); }
        });
      }catch(e){
        console.warn('[auth-bridge] ipc indisponível', e);
      }
    })();
  </script>

  <!-- ===== Views (carregar TODAS antes do router) ===== -->
  <!-- Cadastros -->
  <script src="views/cadastro-produtos.js"></script>
  <script src="views/cadastro-clientes.js"></script>
  <script src="views/cadastro-pedidos.js"></script>

  <!-- Consultas -->
  <script src="views/consulta-produtos.js"></script>
  <script src="views/consulta-clientes.js"></script>
  <script src="views/consulta-pedidos.js"></script>

  <!-- Relatórios -->
  <script src="views/relatorio-faturamento.js"></script>
  <script src="views/relatorio-faturamento-cliente.js"></script>
  <script src="views/relatorio-mov-produtos.js"></script>
  <script src="views/relatorio-historico-comercial.js"></script>

  <!-- Sistema -->
  <script src="views/configuracoes.js"></script>
  <script src="views/perfil.js"></script>
  <script src="views/dashboard.js"></script>

  <!-- Operações -->
  <script src="views/monitor-pedidos.js"></script>

  <!-- ====== Cardápio (NOVA VIEW) ====== -->
  <script src="views/cardapio.js"></script>

  <!-- Router SEMPRE por último -->
  <script src="router.js"></script>
</body>
</html>
